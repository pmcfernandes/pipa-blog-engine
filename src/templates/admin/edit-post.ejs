<%- include('partials/header') %>

  <script type="text/javascript">

        document.addEventListener('alpine:init', () => {
            Alpine.data('editPostPage', () => ({
              slug: '',
              title: '',
              content: '',
              tags: '',
              status: 'published',
              errorMessage: '<%= errorMessage %>',
              showTagsInput: false,

              init() {

                  fetch(`/api/blogs/<%= blogId %>/posts/<%= postId %>`, {
                      method: 'GET',
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': 'Bearer ' + getCookie('admin_jwt_token')
                      }
                    }).then(response => response.json()).then(data => {
                          this.slug = data.slug || '';
                          this.title = data.title || '';
                          this.content  = data.content || '';
                          this.status = data.status || 'draft';
                          this.tags = data.tags || '';

                          if (this.quill) {
                              this.quill.root.innerHTML = this.content || '';
                          }
                    }).catch(err => {
                        this.errorMessage = 'Failed to load post data.';
                    });
              },

              initQuill() {
                  this.quill = new Quill(this.$refs.quillEditor, {
                    placeholder: 'Compose an epic...',
                    theme: 'snow',
                    modules: {
                      toolbar: '#toolbar',
                    }
                  });
                  this.quill.on('text-change', () => {
                    this.content = this.quill.root.innerHTML;
                  });
              },

              submitForm($ev) {
                  if (this.title === '' || this.content === '') {
                      this.errorMessage = 'Title and Content are required.';
                      return;
                  }

                  fetch($ev.target.getAttribute('action'), {
                      method: $ev.target.getAttribute('method'),
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': 'Bearer ' + getCookie('admin_jwt_token')
                      },
                      body: JSON.stringify({
                          title: this.title,
                          content: this.content,
                          published: this.status === 'published',
                          tags: this.tags || ''
                      })
                  }).then(response => response.json()).then(data => {
                      window.location.href = '/admin/dashboard';
                  }).catch(error => {
                      this.errorMessage = 'An error occurred while updating the post.';
                  });
              },

              deletePost(postId) {
                  if (!confirm('Are you sure you want to delete this post?'))
                    return;

                  fetch(`/api/blogs/<%= blogId %>/posts/${postId}`, {
                      method: 'DELETE',
                      headers: { 'Authorization': 'Bearer ' + getCookie('admin_jwt_token') }
                  }).then(() => {
                      window.location.href = '/admin/dashboard';
                  }).catch(() => {
                      this.errorMessage = 'An error occurred while deleting the post.';
                  });
              },

              unpublish() {
                  if (!confirm('Are you sure you want to unpublish this post?'))
                    return;
                  this.status = 'draft';
              },

              publish() {
                  if (!confirm('Are you sure you want to publish this post?'))
                    return;
                  this.status = 'published';
              },

              toggleTagsInput() {
                  this.showTagsInput = !this.showTagsInput;
              }
            }))
        });
  </script>

  <div class="admin-edit-page" x-data="editPostPage" x-init="init()">
    <div class="admin-edit-page-header">
      <div class="admin-edit-page-header-left">
        <a href="/admin/dashboard" class="admin-back-link">Back to Dashboard</a>
      </div>
      <div class="admin-edit-page-header-right">
        <button form="edit-post-form" type="submit" class="admin-save-button">Save Changes</button>
        <div class="menu">
          <button class="menu-button">â˜°</button>
          <div class="menu-content">
            <a href="#"><i class="lni lni-calendar-days"></i> Change published date</a>
            <a x-href="#" @click="toggleTagsInput()"><i class="lni lni-flag-1"></i> Add tags</a>
            <a :href="'/posts/' + slug" target="_blank"><i class="lni lni-link-2-angular-right"></i> See published post</a>
            <hr size="1">
            <a class="red-text" x-href="#" @click="publish()" x-show="status == 'draft'">Publish</a>
            <a class="red-text" x-href="#" @click="unpublish()" x-show="status == 'published'">Unpublish</a>
            <a class="red-text" x-href="#" @click="deletePost(<%= postId %>)">Delete Post</a>
          </div>
        </div>
      </div>
    </div>

    <%- include('partials/quill-toolbar') %>

    <div class="admin-edit-page-content">
      <form id="edit-post-form" action="/api/blogs/<%= blogId %>/posts/<%= postId %>" method="PUT" @submit.prevent="submitForm">
        <div class="admin-error-message" x-show="errorMessage" x-text="errorMessage">
          <%= errorMessage %>
        </div>

        <div>
            <label for="tags" hidden>Tags:</label>
            <input type="text" id="tags" name="tags" x-model="tags" placeholder="tags" x-show="showTagsInput" />
        </div>

        <div>
            <label for="title" hidden>Title:</label>
            <textarea id="title" name="title" x-model="title" rows="1"  placeholder="title"></textarea>
        </div>

        <div>
          <label for="content" hidden>Content</label>
          <textarea id="content" name="content" x-model="content" hidden></textarea>
          <div id="editor" x-ref="quillEditor" x-init="initQuill()"></div>
        </div>
      </form>
    </div>
  </div>

<%- include('partials/footer') %>
